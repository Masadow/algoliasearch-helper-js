<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/SearchResults/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AlgoliaSearchHelper.html">AlgoliaSearchHelper</a><ul class='methods'><li data-type='method'><a href="AlgoliaSearchHelper.html#addDisjunctiveRefine">addDisjunctiveRefine</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#addExclude">addExclude</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#addNumericRefinement">addNumericRefinement</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#addRefine">addRefine</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#clearRefinements">clearRefinements</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#getCurrentPage">getCurrentPage</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#getIndex">getIndex</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#isDisjunctiveRefined">isDisjunctiveRefined</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#isExcluded">isExcluded</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#isRefined">isRefined</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#nextPage">nextPage</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#previousPage">previousPage</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#removeDisjunctiveRefine">removeDisjunctiveRefine</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#removeExclude">removeExclude</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#removeNumericRefinement">removeNumericRefinement</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#removeRefine">removeRefine</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#search">search</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#setCurrentPage">setCurrentPage</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#setIndex">setIndex</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#setQuery">setQuery</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#setState">setState</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#toggleExclude">toggleExclude</a></li><li data-type='method'><a href="AlgoliaSearchHelper.html#toggleRefine">toggleRefine</a></li></ul></li><li><a href="SearchParameters.html">SearchParameters</a><ul class='methods'><li data-type='method'><a href="SearchParameters.html#addDisjunctiveFacetRefinement">addDisjunctiveFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#addExcludeRefinement">addExcludeRefinement</a></li><li data-type='method'><a href="SearchParameters.html#addFacetRefinement">addFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#addNumericRefinement">addNumericRefinement</a></li><li data-type='method'><a href="SearchParameters.html#clearRefinements">clearRefinements</a></li><li data-type='method'><a href="SearchParameters.html#getNumericRefinement">getNumericRefinement</a></li><li data-type='method'><a href="SearchParameters.html#getRefinedDisjunctiveFacets">getRefinedDisjunctiveFacets</a></li><li data-type='method'><a href="SearchParameters.html#getUnrefinedDisjunctiveFacets">getUnrefinedDisjunctiveFacets</a></li><li data-type='method'><a href="SearchParameters.html#isDisjunctiveFacetRefined">isDisjunctiveFacetRefined</a></li><li data-type='method'><a href="SearchParameters.html#isExcludeRefined">isExcludeRefined</a></li><li data-type='method'><a href="SearchParameters.html#isFacetRefined">isFacetRefined</a></li><li data-type='method'><a href="SearchParameters.html#removeDisjunctiveFacetRefinement">removeDisjunctiveFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#removeExcludeRefinement">removeExcludeRefinement</a></li><li data-type='method'><a href="SearchParameters.html#removeFacetRefinement">removeFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#removeNumericRefinement">removeNumericRefinement</a></li><li data-type='method'><a href="SearchParameters.html#setDisjunctiveFacets">setDisjunctiveFacets</a></li><li data-type='method'><a href="SearchParameters.html#setFacets">setFacets</a></li><li data-type='method'><a href="SearchParameters.html#setHitsPerPage">setHitsPerPage</a></li><li data-type='method'><a href="SearchParameters.html#setPage">setPage</a></li><li data-type='method'><a href="SearchParameters.html#setQuery">setQuery</a></li><li data-type='method'><a href="SearchParameters.html#setTypoTolerance">setTypoTolerance</a></li><li data-type='method'><a href="SearchParameters.html#toggleDisjunctiveFacetRefinement">toggleDisjunctiveFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#toggleExcludeFacetRefinement">toggleExcludeFacetRefinement</a></li><li data-type='method'><a href="SearchParameters.html#toggleFacetRefinement">toggleFacetRefinement</a></li></ul></li><li><a href="SearchResults.html">SearchResults</a><ul class='methods'><li data-type='method'><a href="SearchResults.html#getFacetByName">getFacetByName</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-algoliasearch-helper.html">algoliasearch-helper</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">src/SearchResults/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
var forEach = require( "lodash/collection/forEach" );
var compact = require( "lodash/array/compact" );
var find = require( "lodash/collection/find" );

var extend = require( "../functions/extend" );

/**
 * @typedef Facet
 * @type {object}
 * @property {string} name name of the attribute in the record
 * @property {object.&lt;string, number>} data the facetting data : value, number of entries
 * @property {object} stats undefined unless facet_stats is retrieved from algolia
 */

function getIndices( obj ) {
  var indices = {};
  forEach( obj, function( val, idx ) { indices[ val ] = idx; } );
  return indices;
}

function assignFacetStats( dest, facetStats, key ) {
  if ( facetStats &amp;&amp; facetStats[key] ) {
    dest.stats = facetStats[key];
  }
}

function assignFacetTimeout( dest, timeoutCounts, getRankingInfo ) {
  if ( getRankingInfo ) {
    dest.timeout = !!( timeoutCounts );
  }
}

/**
 * Constructor for SearchResults
 * @class
 * @classdesc SearchResults is an object that contains all the data from a
 * helper query.
 * @param {SearchParameters} state state that led to the response
 * @param {object} algoliaResponse the response from algolia client
 **/
var SearchResults = function( state, algoliaResponse ) {
  var mainSubResponse = algoliaResponse.results[ 0 ];

  /**
   * query used to generate the results
   * @member {string}
   */
  this.query = mainSubResponse.query;
  /**
   * all the hits generated for the query
   * @member {array}
   */
  this.hits = mainSubResponse.hits;
  /**
   * index where the results come from
   * @member {string}
   */
  this.index = mainSubResponse.index;
  /**
   * number of hits per page requested
   * @member {number}
   */
  this.hitsPerPage = mainSubResponse.hitsPerPage;
  /**
   * total number of hits of this query on the index
   * @member {number}
   */
  this.nbHits = mainSubResponse.nbHits;
  /**
   * total number of pages with respect to the number of hits per page and the total number of hits
   * @member {number}
   */
  this.nbPages = mainSubResponse.nbPages;
  /**
   * current page
   * @member {number}
   */
  this.page = mainSubResponse.page;
  /**
   * processing time of the main query
   * @member {number}
   */
  this.processingTimeMS = mainSubResponse.processingTimeMS;
  /**
   * disjunctive facets results
   * @member {array}
   */
  this.disjunctiveFacets = [];
  /**
   * other facets results
   * @member {array}
   */
  this.facets = [];

  var disjunctiveFacets = state.getRefinedDisjunctiveFacets();

  var facetsIndices = getIndices( state.facets );
  var disjunctiveFacetsIndices = getIndices( state.disjunctiveFacets );

  //Since we send request only for disjunctive facets that have been refined,
  //we get the facets informations from the first, general, response.
  forEach( mainSubResponse.facets, function( facetValueObject, facetKey ) {
    var isFacetDisjunctive = state.disjunctiveFacets.indexOf( facetKey ) !== -1;
    var position = isFacetDisjunctive ? disjunctiveFacetsIndices[ facetKey ] :
                                        facetsIndices[ facetKey ];
    if( isFacetDisjunctive ) {
      this.disjunctiveFacets[ position ] = {
        name : facetKey,
        data : facetValueObject
      };
      assignFacetStats( this.disjunctiveFacets[ position ], mainSubResponse.facets_stats, facetKey );
      assignFacetTimeout( this.disjunctiveFacets[ position ],
                          state.getRankingInfo,
                          mainSubResponse.timeoutCounts,
                          facetKey );
    }
    else {
      this.facets[ position ] = {
        name : facetKey,
        data : facetValueObject
      };
      assignFacetStats( this.facets[ position ], mainSubResponse.facets_stats, facetKey );
      assignFacetTimeout( this.facets[ position ], state.getRankingInfo, mainSubResponse.timeoutCounts, facetKey );
    }
  }, this );

  // aggregate the refined disjunctive facets
  forEach( disjunctiveFacets, function( disjunctiveFacet, idx ) {
    var result = algoliaResponse.results[ idx + 1 ];

    // There should be only item in facets.
    forEach( result.facets, function( facetResults, dfacet ) {
      var position = disjunctiveFacetsIndices[ dfacet ];

      var dataFromMainRequest = mainSubResponse.facets[ dfacet ];
      this.disjunctiveFacets[ position ] = {
        name : dfacet,
        data : extend( {}, facetResults, dataFromMainRequest )
      };
      assignFacetStats( this.disjunctiveFacets[ position ], result.facets_stats, dfacet );
      assignFacetTimeout( this.disjunctiveFacets[ position ], state.getRankingInfo, result.timeoutCounts, dfacet );

      if ( state.disjunctiveFacetsRefinements[dfacet] ) {
        forEach( state.disjunctiveFacetsRefinements[ dfacet ], function( refinementValue ) {
          // add the disjunctive refinements if it is no more retrieved
          if ( !this.disjunctiveFacets[position].data[refinementValue] &amp;&amp;
               state.disjunctiveFacetsRefinements[dfacet].indexOf( refinementValue ) > -1 ) {
            this.disjunctiveFacets[position].data[refinementValue] = 0;
          }
        }, this );
      }
    }, this );
  }, this );

  // add the excludes
  forEach( state.facetsExcludes, function( excludes, facetName ) {
    var position = facetsIndices[ facetName ];
    this.facets[ position ] = {
      name : facetName,
      data : mainSubResponse.facets[ facetName ]
    };
    forEach( excludes, function( facetValue ) {
      this.facets[ position ] = this.facets[ position ] || { name : facetName };
      this.facets[ position ].data = this.facets[ position ].data || {};
      this.facets[ position ].data[ facetValue ] = 0;
    }, this );
  }, this );

  this.facets = compact( this.facets );
  this.disjunctiveFacets = compact( this.disjunctiveFacets );

  this._state = state;
};

/**
 * Get a facet object with its name
 * @param {string} name name of the attribute facetted
 * @return {Facet} the facet object
 */
SearchResults.prototype.getFacetByName = function( name ) {
  var isName = function( facet ) { return facet.name === name; };
  var indexInFacets = find( this.facets, isName );
  return indexInFacets || find( this.disjunctiveFacets, isName );
};

module.exports = SearchResults;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Thu May 07 2015 13:39:04 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
